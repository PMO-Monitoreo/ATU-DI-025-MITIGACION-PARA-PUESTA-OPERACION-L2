<script>
const DATA_URL = "https://raw.githubusercontent.com/PMO-Monitoreo/ATU-DI-025-MITIGACION-PARA-PUESTA-OPERACION-L2/refs/heads/main/L2_R4.json";

const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20});
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:20});

const map = L.map('map', {layers:[osm], center:[-12.05,-77.05], zoom:11});
L.control.layers({"OpenStreetMap":osm,"Satelital (Esri)":esri}, {}, {collapsed:false}).addTo(map);
L.control.scale().addTo(map);

const pointsLayer = L.layerGroup().addTo(map);
const linesLayer  = L.layerGroup().addTo(map);
const polysLayer  = L.layerGroup().addTo(map);

const lineStyle = {color:"#1464ff", weight:6, opacity:.9, lineCap:"round", lineJoin:"round"};
const polyStyle = {color:"#ff7f0e", weight:2, opacity:.9, fillColor:"#ff7f0e", fillOpacity:.25};

function popup(props){ return props ? Object.entries(props).map(([k,v])=>`${k}: ${v}`).join("<br>") : "Sin datos"; }

fetch(DATA_URL, {cache:"no-cache"})
  .then(r => { if(!r.ok) throw new Error(r.status); return r.json(); })
  .then(geojson => {
    const bounds = L.latLngBounds();

    // Puntos
    const points = L.geoJSON(geojson, {
      filter: f => f.geometry?.type === "Point",
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {radius:5, color:"#005bbb", weight:2, fillColor:"#cfe2ff", fillOpacity:.9})
                                  .bindPopup(popup(f.properties)),
      onEachFeature: (f, layer) => bounds.extend(layer.getLatLng())
    }).addTo(pointsLayer);

    // Líneas
    const lines = L.geoJSON(geojson, {
      filter: f => /LineString$/i.test(f.geometry?.type),
      style: () => lineStyle,
      onEachFeature: (f, layer) => { layer.bindPopup(popup(f.properties)); bounds.extend(layer.getBounds()); }
    }).addTo(linesLayer);

    // Polígonos
    const polys = L.geoJSON(geojson, {
      filter: f => /Polygon$/i.test(f.geometry?.type),
      style: () => polyStyle,
      onEachFeature: (f, layer) => { layer.bindPopup(popup(f.properties)); bounds.extend(layer.getBounds()); }
    }).addTo(polysLayer);

    // Ajuste de vista (no tendrás que hacer zoom manual)
    if (bounds.isValid()) map.fitBounds(bounds, {padding:[30,30], maxZoom: 15});
  })
  .catch(err => console.error("Error cargando GeoJSON:", err));
</script>
